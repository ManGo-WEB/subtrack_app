# Product Requirements Document (PRD): SubTrack

## 1. Обзор проекта

**SubTrack** — это веб-приложение (PWA) для учета и отслеживания регулярных подписок. Приложение решает проблему «подписочной усталости», позволяя пользователям централизовать управление расходами, прогнозировать даты списаний и видеть общую сумму трат в единой валюте (RUB).

### 1.1. Ключевые особенности
*   **Приватность:** Мы не подключаем банковские API. Пользователь вносит данные сам.
*   **Российская специфика:** Основная валюта — рубль. Автоматический пересчет иностранных валют по курсу ЦБ РФ.
*   **Умный ввод:** Каталог популярных сервисов для быстрого добавления (логотип, цвет, название), но без навязывания предустановленных подписок.

### 1.2. Технологический стек
*   **Frontend:** Next.js 15 (App Router), TypeScript, Tailwind CSS.
*   **UI Library:** Shadcn/UI (Radix Primitives).
*   **Backend & Auth:** Supabase (PostgreSQL, GoTrue, Realtime).
*   **AI Code Editor:** Cursor (с жесткими правилами локализации).

---

## 2. Правила работы с Cursor AI (`.cursorrules`)

**ВАЖНО:** Создайте файл `.cursorrules` в корне проекта и поместите туда следующий текст для настройки контекста ИИ:

# Role & Context
Ты — Senior Full-Stack разработчик, создающий приложение SubTrack на стеке Next.js 15 + Supabase. Твоя цель — писать чистый, поддерживаемый код production-уровня.

# LANGUAGE REQUIREMENTS (CRITICAL)
1.  **Общение:** Ты общаешься со мной ИСКЛЮЧИТЕЛЬНО на РУССКОМ языке.
2.  **Код:** Все комментарии в коде, JSDoc и сообщения коммитов (git commit messages) должны быть на РУССКОМ языке.
3.  **UI:** Весь текст в интерфейсе (кнопки, лейблы, ошибки) должен быть на русском языке.

# Technical Constraints
- Используй React Server Components (RSC) по умолчанию. 'use client' добавляй только туда, где есть интерактивность (useState, useEffect).
- Используй Shadcn/UI для всех компонентов интерфейса. Не пиши свои CSS-классы, если можно использовать utility-классы Tailwind.
- Используй Supabase SSR пакет (`@supabase/ssr`) для работы с куками и сессиями.
- Строгая типизация (TypeScript Strict Mode). Никаких `any`.

# Business Logic Rules
1.  **Даты:** Дата следующего платежа рассчитывается строго от "Якорной даты" (Billing Anchor).
    - Формула: `NextPaymentDate = StartDate + N * Interval`.
    - Логика: Следующий платеж происходит в то же число месяца, что и старт (или на следующий день после окончания периода, что математически то же самое).
2.  **Валюты:**
    - Базовая валюта приложения: RUB.
    - Конвертация происходит на лету используя кэшированные курсы.
3.  **Итоговая сумма:**
    - Подписки с периодом `lifetime` (бессрочные) НЕ учитываются в расчете "Сумма в месяц".
    - При выводе сконвертированной суммы добавлять префикс "~" (пример: "~1500 ₽").

---

## 3. Функциональные требования

### 3.1. Аутентификация и Профиль
*   **Регистрация/Вход:** Email + Пароль или Magic Link через Supabase Auth.
*   **Профиль пользователя:** Хранит настройки (базовая валюта — по умолчанию RUB).
*   **Безопасность:** Данные пользователя защищены через RLS (Row Level Security). Никто (даже админ БД в теории) не должен видеть данные пользователя без его токена.

### 3.2. Управление подписками (CRUD)

#### 3.2.1. Добавление подписки
Пользователь нажимает кнопку "Добавить". Открывается форма:
1.  **Поле "Название":** Реализовано как *Combobox* (поиск с автодополнением).
    *   При вводе (например, "Ya") происходит поиск по таблице `services_catalog`.
    *   Если сервис найден (например, "Yandex Plus") — автоматически подтягиваются логотип и фирменный цвет.
    *   Если сервис не найден — пользователь вводит название и выбирает цвет/иконку вручную.
2.  **Поле "Стоимость":** Числовое поле.
3.  **Поле "Валюта":** Выбор (RUB, USD, EUR). По умолчанию RUB.
4.  **Поле "Период":** Выпадающий список:
    *   7 дней
    *   1 месяц
    *   3 месяца
    *   6 месяцев
    *   1 год
    *   Бессрочная (Lifetime)
5.  **Поле "Дата начала":** Datepicker. Является "Якорной датой".

#### 3.2.2. Просмотр и Дашборд
Отображение списка в виде карточек (Grid).
*   **Карточка содержит:** Логотип, Название, Стоимость (в оригинальной валюте), Дата *следующего* списания.
*   **Хедер дашборда:** Отображает "Итого в месяц".
    *   Суммируются все активные подписки.
    *   Lifetime подписки игнорируются.
    *   Валютные подписки конвертируются в RUB.
    *   Отображается дисклеймер: "Примерно, по курсу ЦБ РФ".

#### 3.2.3. Редактирование и Удаление
*   Любую подписку можно открыть и изменить (например, сменился тариф).
*   Удаление должно запрашивать подтверждение ("Вы точно хотите удалить?").

### 3.3. Финансы и Валюты
*   **Источник данных:** API ЦБ РФ (`https://www.cbr-xml-daily.ru/daily_json.js`).
*   **Обновление:** Курсы валют должны кэшироваться в базе данных (таблица `exchange_rates`) и обновляться не чаще 1 раза в сутки (например, через Supabase Edge Function или при первом входе пользователя за день), чтобы не спамить API.

---

## 4. Схема Базы Данных (Supabase)

### 4.1. Таблицы

**`public.profiles`** (Расширение данных пользователя)
*   `id` (uuid, PK) — ссылка на `auth.users`
*   `currency` (text) — дефолтная валюта (RUB)

**`public.services_catalog`** (Общий справочник сервисов)
*   *Доступ:* Чтение для всех authenticated, запись только для service_role.
*   `id` (int, PK)
*   `name` (text) — Название (Netflix, Spotify)
*   `logo_url` (text)
*   `brand_color` (text) — HEX код
*   `default_currency` (text)

**`public.subscriptions`** (Пользовательские подписки)
*   `id` (uuid, PK)
*   `user_id` (uuid, FK) — Владелец
*   `service_id` (int, FK, nullable) — Ссылка на каталог (если выбрано из списка)
*   `name` (text) — Название (копия из каталога или свое)
*   `cost` (numeric) — Сумма
*   `currency` (text) — ISO код (RUB, USD, EUR)
*   `period` (text) — Enum: 'weekly', 'monthly', '3_months', '6_months', 'yearly', 'lifetime'
*   `start_date` (date) — Дата начала (Якорь)
*   `active` (boolean) — Статус подписки

**`public.exchange_rates`** (Кэш курсов)
*   `currency_code` (text, PK) — USD, EUR
*   `rate_to_rub` (numeric) — Курс к рублю
*   `updated_at` (timestamp) — Дата обновления

### 4.2. Логика расчета следующего платежа (SQL/JS Logic)
Так как требование гласит: *"Следующий платеж = следующий день после окончания текущего периода"*, мы используем арифметику интервалов от даты старта.

Пример для JS (date-fns):
```typescript
// Если период 1 месяц
// Start: 15 января
// End of period: 14 февраля
// Next Payment: 15 февраля
function getNextPaymentDate(startDate: Date, period: PeriodType): Date {
  const today = new Date();
  let nextDate = new Date(startDate);
  
  // Если дата старта в будущем, то это и есть дата платежа
  if (nextDate > today) return nextDate;

  if (period === 'lifetime') return null; // Нет следующего платежа

  // Накатываем интервалы, пока дата не станет больше сегодняшней
  while (nextDate <= today) {
     nextDate = add(nextDate, periodToDuration(period)); 
  }
  return nextDate;
}
```

---

## 5. UI/UX Дизайн (Shadcn/UI)

### 5.1. Цветовая палитра
*   Использовать системные цвета Shadcn (Slate/Zinc).
*   Поддержка Dark Mode из коробки.

### 5.2. Компоненты
*   **Combobox:** Для поиска сервиса. Должен поддерживать создание нового элемента ("Create 'MyService'").
*   **Card:** Для отображения подписки.
    *   *Верх:* Иконка + Имя.
    *   *Центр:* Цена крупно (например: "$10").
    *   *Низ:* Мелким шрифтом "След. списание: 15 фев" (если дата близко — подсветить красным).
*   **Skeleton:** Пока данные грузятся, показывать скелетон карточек.

---

## 6. План разработки (Roadmap)

1.  **Setup:** Инициализация Next.js + Supabase. Настройка `.cursorrules`.
2.  **Database:** Создание таблиц в Supabase и настройка RLS политик. Заполнение `services_catalog` (5-10 популярных сервисов для примера).
3.  **Auth:** Настройка страниц входа/регистрации.
4.  **Core Feature:** Реализация формы добавления подписки (связка Combobox с каталогом).
5.  **Dashboard:** Вывод списка подписок и расчет дат.
6.  **Currency:** Подключение API ЦБ РФ и функция пересчета "Итого".
7.  **Polish:** UI твики, иконки, обработка ошибок.